version: '3.8'

services:
  # Django Backend
  backend:
    build: ./backend
    container_name: kaizen_backend_prod
    restart: always
    environment:
      - PRIMARY_DB_HOST=${PRIMARY_DB_HOST:-mysql}
      - PRIMARY_DB_PORT=${PRIMARY_DB_PORT:-3306}
      - PRIMARY_DB_USER=${PRIMARY_DB_USER:-root}
      - PRIMARY_DB_PASSWORD=${PRIMARY_DB_PASSWORD}
      - PRIMARY_DB_NAME=${PRIMARY_DB_NAME:-kaizen_db}
      - DJANGO_DEBUG=False
    ports:
      - "8083:8000"
    volumes:
      - ./media:/app/media
      - static_volume:/app/staticfiles
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --noinput &&
             gunicorn kaizen_backend.wsgi:application --bind 0.0.0.0:8000 --workers 4 --timeout 120"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Frontend (Nginx)
  frontend:
    build: ./frontend
    container_name: kaizen_frontend_prod
    restart: always
    ports:
      - "8503:80"
    depends_on:
      - backend

volumes:
  static_volume:

# 既存のMySQLコンテナのネットワークに接続する場合は、
# 以下のnetworksセクションのコメントを外して、既存のネットワーク名を指定してください
# networks:
#   existing_network:
#     external: true
#     name: 既存のネットワーク名
